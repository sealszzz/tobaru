name: build-tobaru-latest

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu]

    steps:
      - name: Resolve upstream tobaru master HEAD SHA
        id: upstream
        run: |
          sha=$(git ls-remote https://github.com/cfal/tobaru.git refs/heads/master | awk '{print $1}')
          echo "sha=${sha}" >> "$GITHUB_OUTPUT"
          echo "tobaru master HEAD: ${sha}"

      - name: Checkout upstream tobaru at that SHA
        run: |
          git clone https://github.com/cfal/tobaru.git tobaru
          cd tobaru
          git checkout "${{ steps.upstream.outputs.sha }}"
          git log -1 --oneline

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (aarch64 only)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          cargo install cross --locked

      - name: Build (release)
        working-directory: tobaru
        run: |
          set -euo pipefail
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: Pack tar.gz (fixed name, will be overwritten)
        working-directory: tobaru
        env:
          TARGET: ${{ matrix.target }}
        run: |
          set -euo pipefail
          BIN="target/${TARGET}/release/tobaru"
          test -f "$BIN"

          cp "$BIN" tobaru
          strip tobaru 2>/dev/null || true

          TAR="tobaru-${TARGET}.tar.gz"
          tar -czf "$TAR" tobaru
          rm -f tobaru

          ls -lh "$TAR"

      - name: Publish GitHub Release (tag=latest, overwrite assets)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "tobaru latest"
          draft: false
          prerelease: true
          make_latest: true
          overwrite_files: true
          files: |
            tobaru/tobaru-*.tar.gz
          body: |
            Built from upstream master HEAD:
            - tobaru: ${{ steps.upstream.outputs.sha }}
            Release tag is fixed to "latest" and assets are overwritten on each main push.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
